name: Build Ntfy Custom APK

on:
  # Build akan berjalan saat ada push ke main/master atau dijalankan manual
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # Mengizinkan build manual

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # 1. Menyuntikkan Kunci FCM dari Secret
    - name: Inject Google Services JSON (FCM)
      env:
        FCM_BASE64: ${{ secrets.FCM_CONFIG_BASE64 }}
      run: |
        # Mengubah Base64 Secret menjadi file google-services.json
        echo "$FCM_BASE64" | base64 -d > app/google-services.json

    # 2. Mengubah URL Server Default DAN NAMA APLIKASI (Koreksi Nama Aplikasi)
    - name: Change Default Server URL and App Name
      run: |
        # Ganti URL default ntfy.sh ke URL Anda: https://notif.bc13.my.id/
        sed -i 's|https://ntfy.sh|https://notif.bc13.my.id/|g' app/src/main/res/values/strings.xml
        
        # Mengubah nama aplikasi dari "ntfy" menjadi "Desa Cluring Notif"
        sed -i 's|<string name="app_name">ntfy</string>|<string name="app_name">Desa Cluring Notif</string>|g' app/src/main/res/values/strings.xml
        
    - name: Grant Execute Permission for Gradle
      run: chmod +x gradlew

    # 3. Menjalankan Kompilasi Rilis
    - name: Assemble Play Release APK
      run: ./gradlew assemblePlayRelease

    # 4. Mengunggah Hasil APK
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: ntfy-custom-apk
        path: app/build/outputs/apk/play/release/*.apk
