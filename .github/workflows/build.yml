name: Build Ntfy Custom APK

on:
  # Build akan berjalan saat ada push ke main/master atau dijalankan manual
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # Mengizinkan build manual

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # 1. Menyuntikkan Kunci FCM dari Secret (Memakai JSON yang sudah diupdate)
    - name: Inject Google Services JSON (FCM)
      env:
        FCM_BASE64: ${{ secrets.FCM_CONFIG_BASE64 }}
      run: |
        # Mengubah Base64 Secret menjadi file google-services.json
        echo "$FCM_BASE64" | base64 -d > app/google-services.json

    # 2. Apply Custom Configurations (URL, Nama Aplikasi, dan Package Name)
    - name: Apply Custom Configurations
      run: |
        # Ganti URL default ntfy.sh ke URL Anda: https://notif.bc13.my.id/
        sed -i 's|https://ntfy.sh|https://notif.bc13.my.id/|g' app/src/main/res/values/strings.xml
        
        # PERBAIKAN NAMA APLIKASI: Mengubah label "ntfy" menjadi "Desa Cluring Notif"
        sed -i 's|ntfy</string>|Desa Cluring Notif</string>|g' app/src/main/res/values/strings.xml
        
        # PERBAIKAN PACKAGE NAME (applicationId) agar cocok dengan Firebase: ntfy.desacluring
        sed -i 's|applicationId "io.heckel.ntfy"|applicationId "ntfy.desacluring"|g' app/build.gradle
        
    - name: Grant Execute Permission for Gradle
      run: chmod +x gradlew

    # 3. Menjalankan Kompilasi DEBUG (otomatis ditandatangani)
    - name: Assemble Debug APK
      run: ./gradlew assembleDebug

    # 4. Mengunggah Hasil APK
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: ntfy-custom-apk-debug
        path: app/build/outputs/apk/debug/*.apk
